<!DOCTYPE html>
<!--
 * Copyright (c) 2010 The Chromium Authors. All rights reserved.  Use of this
 * source code is governed by a BSD-style license that can be found in the
 * LICENSE file.
 *
 * @author: Menencia
-->
<html>
  <head>
	<script language="javascript" src="jquery.js"></script>
    <script type="text/javascript">
//$(document).ready(function(){

	var url_api = "http://api.betaseries.com";
	var site_url = "http://betaseries.com";
	var key = "6db16a6ffab9";

	/**
	 * Envoie des données en GET vers un des WS de Bétaséries
	 * 
	 * @param category 		Un des WS de Bétaséries
	 * @param params 		Arguments supplémentaires à envoyer
	 * @return callback		Fonction de retour
	 */
	var send = function(category, params, callback) {
		$.ajax({
			type: "POST",
			url: url_api+category+".json",
			data: "key="+key+params,
			dataType: "json",
			//async: false,
			success: callback
		});

		/*var xhr = new XMLHttpRequest();
		var url = url_api+category+".json?key="+key+params;
		xhr.open("GET", url, true);
		xhr.onreadystatechange = function() {
			if (xhr.readyState == 4) {
				var resp = JSON.parse(xhr.responseText);
				callback(resp);
			}
		}
		xhr.send();*/
	};

	function init_badge() {
		chrome.browserAction.setBadgeText({text: "x"});
		chrome.browserAction.setBadgeBackgroundColor({color: [200, 200, 200, 255]});
	}

	/**
	 * Mets à jour le badge
	 *
	 */
	function update_badge() {
		init_badge();
		var params = "&token="+localStorage.token;
		send("/members/episodes/all", params, function (data) {
			var episodes = data.root.episodes;
			var j = 0;
			for (var i in episodes) {
				if (episodes.hasOwnProperty(i)) {
					j += 1;
				}
			}
			if (j > 0) chrome.browserAction.setBadgeText({text: ""+j});
			chrome.browserAction.setBadgeBackgroundColor({color: [150, 0, 0, 255]});
		});
	}

	function auto_update() {
		if (connected()) update_badge();
		setTimeout(auto_update, 1000*60*60); // Mise à jour toutes les heures.
	}

	var connected = function() {
		return (localStorage.token != "" && localStorage.token != undefined);
	};

	/**
	 * INIT
	 *
	 */
	init_badge();
	auto_update();

//});
	  
	</script>
</head>
<body>
</body>
</html>

